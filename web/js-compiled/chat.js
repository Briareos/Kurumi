(function(b){var a=function(c,d){this.authToken=c;this.settings={secure:false,host:"localhost",port:8080,resource:"/socket.io",connectTimeout:5000};this.contentChannelNotificationCallbacks={};this.presenceCallbacks={};this.callbacks={};this.socket=false;this.socketId=false;this.connectionSetupHandlers={};b.extend(this.settings,d)};a.prototype.connect=function(){var c=this;this.scheme=this.settings.secure?"https":"http";this.url=this.scheme+"://"+this.settings.host+":"+this.settings.port;this.resource=this.url+this.resource+"/socket.io.js";if(typeof window.io==="undefined"){throw"IO isn't defined."}this.socket=window.io.connect(this.url,{"connect timeout":this.settings.connectTimeout});this.socket.on("connect",function(){c.socket.emit("authenticate",{authToken:c.authToken});c.socketId=c.socket.socket.sessionid;c.runSetupHandlers("connect");c.socket.on("message",function(e){if(e.clientSocketId===c.socket.socket.sessionid){window.console.log("This message originated from an ajax request from the client associated with this socket.")}if(e.callback&&c.callbacks[e.callback]&&b.isFunction(c.callbacks[e.callback])){try{c.callbacks[e.callback](e)}catch(d){window.console.log(d)}}else{if(typeof e.presenceNotification!=="undefined"){b.each(c.presenceCallbacks,function(){if(b.isFunction(this)){try{this(e)}catch(f){window.console.log(f)}}})}else{if(typeof e.contentChannelNotification!=="undefined"){b.each(c.contentChannelNotificationCallbacks,function(){if(b.isFunction(this)){try{this(e)}catch(f){window.console.log(f)}}})}}}})});this.socket.on("disconnect",function(){c.runSetupHandlers("disconnect")});setTimeout(function(){if(!c.socket.socket.connected){c.runSetupHandlers("connectionFailure")}},this.settings.connectTimeout+250)};a.prototype.runSetupHandlers=function(c){b.each(this.connectionSetupHandlers,function(){if(b.isFunction(this[c])){try{this[c]()}catch(d){throw d}}})};a.prototype.disconnect=function(){this.socket.emit("disconnect");this.socket.disconnect();delete window.io.sockets[this.url]};window.Nodejs=a})(jQuery);
(function(a){var b=function(d,c){this.nodejs=d;this.settings={container:"body",tpl:{status:"",user:"",window:"",message:"",messages:"",chat:""},url:{cache:"",activate:"",close:"",send:"",ping:""}};a.extend(this.settings,c);this.status=false};b.prototype.initialize=function(){var c=this;c.context=a(c.compileTpl("chat"));a(c.settings.container).append(c.context);a(c.context).on("click",'[data-chat="toggle"]',function(){var d=a(this);var e=d.data("uid");if(c.isNumber(e)){e=window.parseInt(e);if(c.data.a===e){c.data.a=0;c.localDeactivateWindow(e);c.remoteDeactivateWindow(e)}else{c.localDeactivateWindow(c.data.a);c.data.a=e;c.localActivateWindow(e);c.remoteActivateWindow(e)}}else{if(c.status){c.status=false;c.localDeactivateStatus()}else{c.status=true;c.localActivateStatus()}}return false});a(c.context).on("click",'[data-chat="user"]',function(){var d=a(this);var e=window.parseInt(d.data("uid"));if(a.inArray(e,c.data.v)===-1){var f={u:e,n:d.data("name"),p:d.data("picture")};c.data.v.push(e);c.localCreateWindow(f)}if(c.data.a!==e){c.localDeactivateWindow(c.data.a);c.data.a=e;c.localActivateWindow(e);c.remoteActivateWindow(e)}return false});a(this.context).on("click",'[data-chat="minimize"]',function(g){var d=a(g.srcElement);if(d.data("chat")==="minimize"){var f=d.data("uid");c.localDeactivateWindow(f);if(c.isNumber(f)){f=window.parseInt(f);c.data.a=0;c.remoteDeactivateWindow(f)}else{c.status=false}}return false});a(this.context).on("click",'[data-chat="close"]',function(){var d=a(this);var f=window.parseInt(d.data("uid"));if(c.data.a===f){c.data.a=0}var e=a.inArray(f,c.data.v);c.data.v.splice(e,e+1);c.localCloseWindow(f);c.remoteCloseWindow(f);return false});a(c.context).on("click",'[data-chat="focus"]',function(){var d=a(this);var e=window.parseInt(d.data("uid"));c.data.a=e;c.localActivateWindow(e)});a(c.context).on("keyup",'[data-chat="input"]',function(){var d=a(this);var e=d.data("uid");var g="chat-clone-"+e;var f=a("#"+g,c.context);if(!f.length){f=a("<div />").attr("id",g).addClass(d.attr("class")).css({maxHeight:"none",position:"absolute",wordWrap:"break-word",height:"auto",display:"none"});d.after(f)}f.html(d.val().replace(/&/g,"&amp;").replace(/ {2}/g," &nbsp;").replace(/<|>/g,"&gt;").replace(/\n/g,"<br />")+"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");d.css("height",f.height())});a(c.context).on("keydown",'[data-chat="input"]',function(j){if(j.keyCode===13){var d=a(this);var f=window.parseInt(d.data("uid"));var h={u:f,n:d.data("name"),p:d.data("picture")};var i=d.val();var g={i:0,t:new Date().getTime()/1000,b:c.escape(i),r:false};c.localSendMessage(h,g);c.remoteSendMessage(f,i);d.val("");return false}});a.post(c.settings.url.cache,{token:c.nodejs.authToken},function(n){c.tid=c.nodejs.socketId;c.data=n;c.state={};c.pong=0;c.pingInterval=setInterval(function(){var i=window.parseInt(new Date().getTime()/1000);if((i-c.pong)>=300){a.post(c.settings.url.ping,{token:c.nodejs.authToken})}},303*1000);c.user={u:n.u,n:n.n,p:n.p};var h="";var q=0;for(var m in c.data.o){if(c.data.o.hasOwnProperty(m)){var l=c.data.o[m];var g={uid:l.u,name:l.n,status:l.s,picture:l.p};h+=c.compileTpl("user",g);q++}}var f={users:h,count:q};h=c.compileTpl("status",f);a('[data-chat="placeholder"]',c.context).replaceWith(h);for(var o=0;o<c.data.v.length;o++){var p=n.v[o];var d=n.w[p];var e=d.d;c.localCreateWindow(e);for(var k in d.m){var r=d.m[k];c.localSendMessage(e,r)}if(d.e){c.newMessages(p,d.e)}}if(c.data.a){c.localActivateWindow(c.data.a);c.scrollToBottom(c.data.a)}c.nodejs.callbacks["chat_"+c.user.u]=function(t){var v=(t.data.tid===c.tid);switch(t.data.command){case"pong":c.pong=new Date().getTime()/1000;break;case"message":if(t.data.receiver.u===c.user.u){t.data.message.r=true;if(a.inArray(t.data.sender.u,c.data.v)===-1){if(c.data.a===0&&a.inArray(t.data.sender.u,c.data.v)===-1){c.localCreateWindow(t.data.sender);c.localActivateWindow(t.data.sender.u);c.data.a=t.data.sender.u;c.remoteActivateWindow(t.data.sender.u)}else{c.localCreateWindow(t.data.sender)}c.data.v.push(t.data.sender.u)}var u=c.isScrolledToBottom(t.data.sender.u);c.localSendMessage(t.data.sender,t.data.message);if(u){c.scrollToBottom(t.data.sender.u)}if(c.data.a!==t.data.sender.u){c.newMessages(t.data.sender.u)}}else{t.data.message.r=false;if(!v){var i=c.isScrolledToBottom(t.data.receiver.u);c.localSendMessage(t.data.receiver,t.data.message);if(i){c.scrollToBottom(t.data.receiver.u)}}else{c.localUpdateMessage(t.data.sender.u,t.data.message.i,t.data.message.b)}}break;case"close":if(!v){c.localCloseWindow(t.data.uid);var s=a.inArray(t.data.uid,c.data.v);c.data.v.splice(s,s+1);if(c.data.a===t.data.uid){c.data.a=0}}break;case"activate":if(!v){if(t.data.uid===0){c.localDeactivateWindow(c.data.a)}else{var j=a.inArray(t.data.uid,c.data.v);if(j===-1){c.data.v.push(t.data.uid);c.localCreateWindow(t.data.d)}c.localActivateWindow(t.data.uid);c.scrollToBottom(t.data.uid);c.noNewMessages(t.data.uid)}c.data.a=t.data.uid}break}}})};b.prototype.isNumber=function(c){return !isNaN(parseFloat(c))&&isFinite(c)};b.prototype.newMessages=function(c,d){a('[data-chat="window"][data-uid="'+c+'"]',this.context).addClass("new-messages")};b.prototype.noNewMessages=function(c){a('[data-chat="window"][data-uid="'+c+'"]',this.context).removeClass("new-messages")};b.prototype.escape=function(c){return c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};b.prototype.generateTid=function(){var f="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var c=12;var g="";for(var d=0;d<c;d++){var e=Math.floor(Math.random()*f.length);g+=f.substring(e,e+1)}return g};b.prototype.isScrolledToBottom=function(d){if(this.data.a!==d){return false}var c=a('[data-chat="focus"][data-uid="'+d+'"]');return(c.prop("scrollHeight")-c.scrollTop())===c.height()};b.prototype.scrollToBottom=function(d){var c=a('[data-chat="focus"][data-uid="'+d+'"]');c.scrollTop(c.prop("scrollHeight")-c.height())};b.prototype.compileTpl=function(e,f){var c=this.settings.tpl[e];f=f||{};for(var d in f){if(f.hasOwnProperty(d)){c=c.replace(new RegExp("\\${"+d+"}","gm"),f[d])}}return c};b.prototype.generateWindow=function(e,d){d=d||"";var c={uid:e.u,name:e.n,picture:e.p,messages:d};return this.compileTpl("window",c)};b.prototype.localDeactivateWindow=function(c){a('[data-chat="window"][data-uid="'+c+'"]',this.context).removeClass("active");a('[data-chat="panel"][data-uid="'+c+'"]',this.context).hide()};b.prototype.localCreateWindow=function(c){this.state[c.u]={last:false};var d=a(this.generateWindow(c));a('[data-chat="windows"]',this.context).prepend(d)};b.prototype.localActivateStatus=function(){a('[data-chat="window"][data-uid="status"]',this.context).addClass("active");a('[data-chat="panel"][data-uid="status"]',this.context).show()};b.prototype.localDeactivateStatus=function(){a('[data-chat="window"][data-uid="status"]',this.context).removeClass("active");a('[data-chat="panel"][data-uid="status"]',this.context).hide()};b.prototype.localActivateWindow=function(d){for(var c=0;c<this.data.v.length;c++){if(this.data.v[c]!==d){this.localDeactivateWindow(d)}}a('[data-chat="window"][data-uid="'+d+'"]',this.context).addClass("active");a('[data-chat="panel"][data-uid="'+d+'"]',this.context).show();a('[data-chat="input"][data-uid="'+d+'"]',this.context).focus();this.noNewMessages(d);this.scrollToBottom(d)};b.prototype.localCloseWindow=function(c){delete this.state[c];a('[data-chat="window"][data-uid="'+c+'"]').remove()};b.prototype.localSendMessage=function(h,g){var i=new Date();var d=this.isScrolledToBottom(h.u);i.setTime((window.parseInt(g.t))*1000);var c=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var f={uid:g.r?h.u:this.user.u,cmid:g.i,name:g.r?h.n:this.user.n,picture:g.r?h.p:this.user.p,body:g.b,time:i.getDate()+". "+c[i.getMonth()]+" '"+String(i.getFullYear()).substring(2,4)+". @ "+i.getHours()+":"+i.getMinutes()};if(this.state[h.u].last===false||this.state[h.u].last.r!==g.r){var j=a(this.compileTpl("messages",f));a('[data-chat=conversation][data-uid="'+h.u+'"]',this.context).append(j)}var e=a(this.compileTpl("message",f));a('[data-chat="conversation"][data-uid="'+h.u+'"] *[data-chat="messages"]:last',this.context).append(e);this.state[h.u].last=g;if(d){this.scrollToBottom(h.u)}};b.prototype.localUpdateMessage=function(d,c,e){a('[data-chat="message"][data-uid="'+d+'"][data-cmid="0"]:first').attr("data-cmid",c).html(e)};b.prototype.remoteDeactivateWindow=function(d){var c={uid:0,tid:this.tid,token:this.nodejs.authToken};a.post(this.settings.url.activate,c)};b.prototype.remoteActivateWindow=function(d){var c={uid:d,tid:this.tid,token:this.nodejs.authToken};a.post(this.settings.url.activate,c)};b.prototype.remoteCloseWindow=function(d){var c={uid:d,tid:this.tid,token:this.nodejs.authToken};a.post(this.settings.url.close,c)};b.prototype.remoteSendMessage=function(d,e){var c={uid:d,message:e,tid:this.tid,token:this.nodejs.authToken};a.post(this.settings.url.send,c)};b.prototype.unload=function(){this.context.remove()};window.Chat=b})(jQuery);